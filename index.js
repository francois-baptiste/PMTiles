var Ne={},Bt=function(t,e,r,n,i){var a=new Worker(Ne[e]||(Ne[e]=URL.createObjectURL(new Blob([t+';addEventListener("error",function(e){e=e.error;postMessage({$e$:[e.message,e.code,e.stack]})})'],{type:"text/javascript"}))));return a.onmessage=function(o){var u=o.data,f=u.$e$;if(f){var s=new Error(f[0]);s.code=f[1],s.stack=f[2],i(s,null)}else i(null,u)},a.postMessage(r,n),a},U=Uint8Array,j=Uint16Array,be=Uint32Array,Ee=new U([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),De=new U([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Je=new U([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ye=function(t,e){for(var r=new j(31),n=0;n<31;++n)r[n]=e+=1<<t[n-1];for(var i=new be(r[30]),n=1;n<30;++n)for(var a=r[n];a<r[n+1];++a)i[a]=a-r[n]<<5|n;return[r,i]},Xe=Ye(Ee,2),Te=Xe[0],Lt=Xe[1];Te[28]=258,Lt[258]=28;var Qe=Ye(De,0),_e=Qe[0],Br=Qe[1],de=new j(32768);for(p=0;p<32768;++p)H=(p&43690)>>>1|(p&21845)<<1,H=(H&52428)>>>2|(H&13107)<<2,H=(H&61680)>>>4|(H&3855)<<4,de[p]=((H&65280)>>>8|(H&255)<<8)>>>1;var H,p,te=function(t,e,r){for(var n=t.length,i=0,a=new j(e);i<n;++i)t[i]&&++a[t[i]-1];var o=new j(e);for(i=0;i<e;++i)o[i]=o[i-1]+a[i-1]<<1;var u;if(r){u=new j(1<<e);var f=15-e;for(i=0;i<n;++i)if(t[i])for(var s=i<<4|t[i],h=e-t[i],l=o[t[i]-1]++<<h,c=l|(1<<h)-1;l<=c;++l)u[de[l]>>>f]=s}else for(u=new j(n),i=0;i<n;++i)t[i]&&(u[i]=de[o[t[i]-1]++]>>>15-t[i]);return u},fe=new U(288);for(p=0;p<144;++p)fe[p]=8;var p;for(p=144;p<256;++p)fe[p]=9;var p;for(p=256;p<280;++p)fe[p]=7;var p;for(p=280;p<288;++p)fe[p]=8;var p,et=new U(32);for(p=0;p<32;++p)et[p]=5;var p;var tt=te(fe,9,1);var rt=te(et,5,1),we=function(t){for(var e=t[0],r=1;r<t.length;++r)t[r]>e&&(e=t[r]);return e},S=function(t,e,r){var n=e/8|0;return(t[n]|t[n+1]<<8)>>(e&7)&r},xe=function(t,e){var r=e/8|0;return(t[r]|t[r+1]<<8|t[r+2]<<16)>>(e&7)},nt=function(t){return(t+7)/8|0},se=function(t,e,r){(e==null||e<0)&&(e=0),(r==null||r>t.length)&&(r=t.length);var n=new(t.BYTES_PER_ELEMENT==2?j:t.BYTES_PER_ELEMENT==4?be:U)(r-e);return n.set(t.subarray(e,r)),n};var it=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],d=function(t,e,r){var n=new Error(e||it[t]);if(n.code=t,Error.captureStackTrace&&Error.captureStackTrace(n,d),!r)throw n;return n},Me=function(t,e,r){var n=t.length;if(!n||r&&r.f&&!r.l)return e||new U(0);var i=!e||r,a=!r||r.i;r||(r={}),e||(e=new U(n*3));var o=function(_){var ee=e.length;if(_>ee){var oe=new U(Math.max(ee*2,_));oe.set(e),e=oe}},u=r.f||0,f=r.p||0,s=r.b||0,h=r.l,l=r.d,c=r.m,A=r.n,w=n*8;do{if(!h){u=S(t,f,1);var v=S(t,f+1,3);if(f+=3,v)if(v==1)h=tt,l=rt,c=9,A=5;else if(v==2){var B=S(t,f,31)+257,$=S(t,f+10,15)+4,q=B+S(t,f+5,31)+1;f+=14;for(var G=new U(q),W=new U(19),x=0;x<$;++x)W[Je[x]]=S(t,f+x*3,7);f+=$*3;for(var J=we(W),b=(1<<J)-1,pe=te(W,J,1),x=0;x<q;){var ge=pe[S(t,f,b)];f+=ge&15;var y=ge>>>4;if(y<16)G[x++]=y;else{var k=0,N=0;for(y==16?(N=3+S(t,f,3),f+=2,k=G[x-1]):y==17?(N=3+S(t,f,7),f+=3):y==18&&(N=11+S(t,f,127),f+=7);N--;)G[x++]=k}}var R=G.subarray(0,B),E=G.subarray(B);c=we(R),A=we(E),h=te(R,c,1),l=te(E,A,1)}else d(1);else{var y=nt(f)+4,z=t[y-4]|t[y-3]<<8,m=y+z;if(m>n){a&&d(0);break}i&&o(s+z),e.set(t.subarray(y,m),s),r.b=s+=z,r.p=f=m*8,r.f=u;continue}if(f>w){a&&d(0);break}}i&&o(s+131072);for(var me=(1<<c)-1,D=(1<<A)-1,ae=f;;ae=f){var k=h[xe(t,f)&me],K=k>>>4;if(f+=k&15,f>w){a&&d(0);break}if(k||d(2),K<256)e[s++]=K;else if(K==256){ae=f,h=null;break}else{var Y=K-254;if(K>264){var x=K-257,C=Ee[x];Y=S(t,f,(1<<C)-1)+Te[x],f+=C}var X=l[xe(t,f)&D],O=X>>>4;X||d(3),f+=X&15;var E=_e[O];if(O>3){var C=De[O];E+=xe(t,f)&(1<<C)-1,f+=C}if(f>w){a&&d(0);break}i&&o(s+131072);for(var Q=s+Y;s<Q;s+=4)e[s]=e[s-E],e[s+1]=e[s+1-E],e[s+2]=e[s+2-E],e[s+3]=e[s+3-E];s=Q}}r.l=h,r.p=ae,r.b=s,r.f=u,h&&(u=1,r.m=c,r.d=l,r.n=A)}while(!u);return s==e.length?e:se(e,0,s)};var Pt=new U(0);var It=function(t,e){var r={};for(var n in t)r[n]=t[n];for(var n in e)r[n]=e[n];return r},$e=function(t,e,r){for(var n=t(),i=t.toString(),a=i.slice(i.indexOf("[")+1,i.lastIndexOf("]")).replace(/\s+/g,"").split(","),o=0;o<n.length;++o){var u=n[o],f=a[o];if(typeof u=="function"){e+=";"+f+"=";var s=u.toString();if(u.prototype)if(s.indexOf("[native code]")!=-1){var h=s.indexOf(" ",8)+1;e+=s.slice(h,s.indexOf("(",h))}else{e+=s;for(var l in u.prototype)e+=";"+f+".prototype."+l+"="+u.prototype[l].toString()}else e+=s}else r[f]=u}return[e,r]},ye=[],Zt=function(t){var e=[];for(var r in t)t[r].buffer&&e.push((t[r]=new t[r].constructor(t[r])).buffer);return e},Rt=function(t,e,r,n){var i;if(!ye[r]){for(var a="",o={},u=t.length-1,f=0;f<u;++f)i=$e(t[f],a,o),a=i[0],o=i[1];ye[r]=$e(t[u],a,o)}var s=It({},ye[r][1]);return Bt(ye[r][0]+";onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage="+e.toString()+"}",r,s,Zt(s),n)},Ce=function(){return[U,j,be,Ee,De,Je,Te,_e,tt,rt,de,it,te,we,S,xe,nt,se,d,Me,Kt,Ft,Vt]};var Ot=function(){return[at,Gt]};var Ht=function(){return[kt]},Ft=function(t){return postMessage(t,[t.buffer])},Vt=function(t){return t&&t.size&&new U(t.size)};var re=function(t){return t.ondata=function(e,r){return postMessage([e,r],[e.buffer])},function(e){return t.push(e.data[0],e.data[1])}},Se=function(t,e,r,n,i){var a,o=Rt(t,n,i,function(u,f){u?(o.terminate(),e.ondata.call(e,u)):(f[1]&&o.terminate(),e.ondata.call(e,u,f[0],f[1]))});o.postMessage(r),e.push=function(u,f){e.ondata||d(5),a&&e.ondata(d(4,0,1),null,!!f),o.postMessage([u,a=f],[u.buffer])},e.terminate=function(){o.terminate()}};var at=function(t){(t[0]!=31||t[1]!=139||t[2]!=8)&&d(6,"invalid gzip data");var e=t[3],r=10;e&4&&(r+=t[10]|(t[11]<<8)+2);for(var n=(e>>3&1)+(e>>4&1);n>0;n-=!t[r++]);return r+(e&2)},Gt=function(t){var e=t.length;return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0};var kt=function(t){((t[0]&15)!=8||t[0]>>>4>7||(t[0]<<8|t[1])%31)&&d(6,"invalid zlib data"),t[1]&32&&d(6,"invalid zlib data: preset dictionaries not supported")};var Z=function(){function t(e){this.s={},this.p=new U(0),this.ondata=e}return t.prototype.e=function(e){this.ondata||d(5),this.d&&d(4);var r=this.p.length,n=new U(r+e.length);n.set(this.p),n.set(e,r),this.p=n},t.prototype.c=function(e){this.d=this.s.i=e||!1;var r=this.s.b,n=Me(this.p,this.o,this.s);this.ondata(se(n,r,this.s.b),this.d),this.o=se(n,this.s.b-32768),this.s.b=this.o.length,this.p=se(this.p,this.s.p/8|0),this.s.p&=7},t.prototype.push=function(e,r){this.e(e),this.c(r)},t}();var ot=function(){function t(e){this.ondata=e,Se([Ce,function(){return[re,Z]}],this,0,function(){var r=new Z;onmessage=re(r)},7)}return t}();function Kt(t,e){return Me(t,e)}var qe=function(){function t(e){this.v=1,Z.call(this,e)}return t.prototype.push=function(e,r){if(Z.prototype.e.call(this,e),this.v){var n=this.p.length>3?at(this.p):4;if(n>=this.p.length&&!r)return;this.p=this.p.subarray(n),this.v=0}r&&(this.p.length<8&&d(6,"invalid gzip data"),this.p=this.p.subarray(0,-8)),Z.prototype.c.call(this,r)},t}();var st=function(){function t(e){this.ondata=e,Se([Ce,Ot,function(){return[re,Z,qe]}],this,0,function(){var r=new qe;onmessage=re(r)},9)}return t}();var We=function(){function t(e){this.v=1,Z.call(this,e)}return t.prototype.push=function(e,r){if(Z.prototype.e.call(this,e),this.v){if(this.p.length<2&&!r)return;this.p=this.p.subarray(2),this.v=0}r&&(this.p.length<4&&d(6,"invalid zlib data"),this.p=this.p.subarray(0,-4)),Z.prototype.c.call(this,r)},t}();var ft=function(){function t(e){this.ondata=e,Se([Ce,Ht,function(){return[re,Z,We]}],this,0,function(){var r=new We;onmessage=re(r)},11)}return t}();var jt=typeof TextDecoder<"u"&&new TextDecoder,Nt=0;try{jt.decode(Pt,{stream:!0}),Nt=1}catch{}var $t={gzip:st,deflate:ft,"deflate-raw":ot},qt=(t,e,r)=>{class n extends t{constructor(a){if(!arguments.length)throw new TypeError(`Failed to construct '${r}': 1 argument required, but only 0 present.`);let o=e[a];if(!o)throw new TypeError(`Failed to construct '${r}': Unsupported compression format: '${a}'`);let u=new o,f;super({start:s=>{u.ondata=(h,l,c)=>{h?s.error(h):l&&(s.enqueue(l),c&&s.terminate()),f()}},transform:s=>new Promise(h=>{if(f=h,s instanceof ArrayBuffer)s=new Uint8Array(s);else if(ArrayBuffer.isView(s))s=new Uint8Array(s.buffer,s.byteOffset,s.byteLength);else throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'");u.push(s)}),flush:()=>new Promise(s=>{f=s,u.push(new Uint8Array(0),!0)})},{size:s=>s.byteLength|0,highWaterMark:65536})}}return n};function ut(t){class e extends qt(t,$t,"DecompressionStream"){}return e}var M=Uint8Array,ne=Uint16Array,Wt=Int32Array,lt=new M([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ht=new M([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Jt=new M([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ct=function(t,e){for(var r=new ne(31),n=0;n<31;++n)r[n]=e+=1<<t[n-1];for(var i=new Wt(r[30]),n=1;n<30;++n)for(var a=r[n];a<r[n+1];++a)i[a]=a-r[n]<<5|n;return{b:r,r:i}},vt=ct(lt,2),pt=vt.b,Yt=vt.r;pt[28]=258,Yt[258]=28;var gt=ct(ht,0),Xt=gt.b,Hr=gt.r,Pe=new ne(32768);for(g=0;g<32768;++g)F=(g&43690)>>1|(g&21845)<<1,F=(F&52428)>>2|(F&13107)<<2,F=(F&61680)>>4|(F&3855)<<4,Pe[g]=((F&65280)>>8|(F&255)<<8)>>1;var F,g,ue=function(t,e,r){for(var n=t.length,i=0,a=new ne(e);i<n;++i)t[i]&&++a[t[i]-1];var o=new ne(e);for(i=1;i<e;++i)o[i]=o[i-1]+a[i-1]<<1;var u;if(r){u=new ne(1<<e);var f=15-e;for(i=0;i<n;++i)if(t[i])for(var s=i<<4|t[i],h=e-t[i],l=o[t[i]-1]++<<h,c=l|(1<<h)-1;l<=c;++l)u[Pe[l]>>f]=s}else for(u=new ne(n),i=0;i<n;++i)t[i]&&(u[i]=Pe[o[t[i]-1]++]>>15-t[i]);return u},le=new M(288);for(g=0;g<144;++g)le[g]=8;var g;for(g=144;g<256;++g)le[g]=9;var g;for(g=256;g<280;++g)le[g]=7;var g;for(g=280;g<288;++g)le[g]=8;var g,mt=new M(32);for(g=0;g<32;++g)mt[g]=5;var g;var Qt=ue(le,9,1);var _t=ue(mt,5,1),Be=function(t){for(var e=t[0],r=1;r<t.length;++r)t[r]>e&&(e=t[r]);return e},P=function(t,e,r){var n=e/8|0;return(t[n]|t[n+1]<<8)>>(e&7)&r},Le=function(t,e){var r=e/8|0;return(t[r]|t[r+1]<<8|t[r+2]<<16)>>(e&7)},er=function(t){return(t+7)/8|0},tr=function(t,e,r){(e==null||e<0)&&(e=0),(r==null||r>t.length)&&(r=t.length);var n=new M(r-e);return n.set(t.subarray(e,r)),n};var rr=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],T=function(t,e,r){var n=new Error(e||rr[t]);if(n.code=t,Error.captureStackTrace&&Error.captureStackTrace(n,T),!r)throw n;return n},Ie=function(t,e,r,n){var i=t.length,a=n?n.length:0;if(!i||e.f&&!e.l)return r||new M(0);var o=!r||e.i!=2,u=e.i;r||(r=new M(i*3));var f=function(ke){var Ke=r.length;if(ke>Ke){var je=new M(Math.max(Ke*2,ke));je.set(r),r=je}},s=e.f||0,h=e.p||0,l=e.b||0,c=e.l,A=e.d,w=e.m,v=e.n,y=i*8;do{if(!c){s=P(t,h,1);var z=P(t,h+1,3);if(h+=3,z)if(z==1)c=Qt,A=_t,w=9,v=5;else if(z==2){var q=P(t,h,31)+257,G=P(t,h+10,15)+4,W=q+P(t,h+5,31)+1;h+=14;for(var x=new M(W),J=new M(19),b=0;b<G;++b)J[Jt[b]]=P(t,h+b*3,7);h+=G*3;for(var pe=Be(J),ge=(1<<pe)-1,k=ue(J,pe,1),b=0;b<W;){var N=k[P(t,h,ge)];h+=N&15;var m=N>>4;if(m<16)x[b++]=m;else{var R=0,E=0;for(m==16?(E=3+P(t,h,3),h+=2,R=x[b-1]):m==17?(E=3+P(t,h,7),h+=3):m==18&&(E=11+P(t,h,127),h+=7);E--;)x[b++]=R}}var me=x.subarray(0,q),D=x.subarray(q);w=Be(me),v=Be(D),c=ue(me,w,1),A=ue(D,v,1)}else T(1);else{var m=er(h)+4,B=t[m-4]|t[m-3]<<8,$=m+B;if($>i){u&&T(0);break}o&&f(l+B),r.set(t.subarray(m,$),l),e.b=l+=B,e.p=h=$*8,e.f=s;continue}if(h>y){u&&T(0);break}}o&&f(l+131072);for(var ae=(1<<w)-1,K=(1<<v)-1,Y=h;;Y=h){var R=c[Le(t,h)&ae],C=R>>4;if(h+=R&15,h>y){u&&T(0);break}if(R||T(2),C<256)r[l++]=C;else if(C==256){Y=h,c=null;break}else{var X=C-254;if(C>264){var b=C-257,O=lt[b];X=P(t,h,(1<<O)-1)+pt[b],h+=O}var Q=A[Le(t,h)&K],_=Q>>4;Q||T(3),h+=Q&15;var D=Xt[_];if(_>3){var O=ht[_];D+=Le(t,h)&(1<<O)-1,h+=O}if(h>y){u&&T(0);break}o&&f(l+131072);var ee=l+X;if(l<D){var oe=a-D,St=Math.min(D,ee);for(oe+l<0&&T(3);l<St;++l)r[l]=n[oe+l]}for(;l<ee;l+=4)r[l]=r[l-D],r[l+1]=r[l+1-D],r[l+2]=r[l+2-D],r[l+3]=r[l+3-D];l=ee}}e.l=c,e.p=Y,e.b=l,e.f=s,c&&(s=1,e.m=w,e.d=A,e.n=v)}while(!s);return l==r.length?r:tr(r,0,l)};var nr=new M(0);var ir=function(t){(t[0]!=31||t[1]!=139||t[2]!=8)&&T(6,"invalid gzip data");var e=t[3],r=10;e&4&&(r+=(t[10]|t[11]<<8)+2);for(var n=(e>>3&1)+(e>>4&1);n>0;n-=!t[r++]);return r+(e&2)},ar=function(t){var e=t.length;return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0};var or=function(t,e){return((t[0]&15)!=8||t[0]>>4>7||(t[0]<<8|t[1])%31)&&T(6,"invalid zlib data"),(t[1]>>5&1)==+!e&&T(6,"invalid zlib data: "+(t[1]&32?"need":"unexpected")+" dictionary"),(t[1]>>3&4)+2};function sr(t,e){return Ie(t,{i:2},e&&e.out,e&&e.dictionary)}function fr(t,e){var r=ir(t);return r+8>t.length&&T(6,"invalid gzip data"),Ie(t.subarray(r,-8),{i:2},e&&e.out||new M(ar(t)),e&&e.dictionary)}function ur(t,e){return Ie(t.subarray(or(t,e&&e.dictionary),-4),{i:2},e&&e.out,e&&e.dictionary)}function Ze(t,e){return t[0]==31&&t[1]==139&&t[2]==8?fr(t,e):(t[0]&15)!=8||t[0]>>4>7||(t[0]<<8|t[1])%31?sr(t,e):ur(t,e)}var lr=typeof TextDecoder<"u"&&new TextDecoder,hr=0;try{lr.decode(nr,{stream:!0}),hr=1}catch{}var xt=(t,e)=>t*Math.pow(2,e),he=(t,e)=>Math.floor(t/Math.pow(2,e)),ze=(t,e)=>xt(t.getUint16(e+1,!0),8)+t.getUint8(e),dt=(t,e)=>xt(t.getUint32(e+2,!0),16)+t.getUint16(e,!0),cr=(t,e,r,n,i)=>{if(t!=n.getUint8(i))return t-n.getUint8(i);let a=ze(n,i+1);if(e!=a)return e-a;let o=ze(n,i+4);return r!=o?r-o:0},vr=(t,e,r,n)=>{let i=zt(t,e|128,r,n);return i?{z:e,x:r,y:n,offset:i[0],length:i[1],is_dir:!0}:null},yt=(t,e,r,n)=>{let i=zt(t,e,r,n);return i?{z:e,x:r,y:n,offset:i[0],length:i[1],is_dir:!1}:null},zt=(t,e,r,n)=>{let i=0,a=t.byteLength/17-1;for(;i<=a;){let o=a+i>>1,u=cr(e,r,n,t,o*17);if(u>0)i=o+1;else if(u<0)a=o-1;else return[dt(t,o*17+7),t.getUint32(o*17+13,!0)]}return null},pr=(t,e)=>t.is_dir&&!e.is_dir?1:!t.is_dir&&e.is_dir?-1:t.z!==e.z?t.z-e.z:t.x!==e.x?t.x-e.x:t.y-e.y,At=(t,e)=>{let r=t.getUint8(e*17);return{z:r&127,x:ze(t,e*17+1),y:ze(t,e*17+4),offset:dt(t,e*17+7),length:t.getUint32(e*17+13,!0),is_dir:r>>7===1}},wt=t=>{let e=[],r=new DataView(t);for(let n=0;n<r.byteLength/17;n++)e.push(At(r,n));return gr(e)},gr=t=>{t.sort(pr);let e=new ArrayBuffer(17*t.length),r=new Uint8Array(e);for(let n=0;n<t.length;n++){let i=t[n],a=i.z;i.is_dir&&(a=a|128),r[n*17]=a,r[n*17+1]=i.x&255,r[n*17+2]=i.x>>8&255,r[n*17+3]=i.x>>16&255,r[n*17+4]=i.y&255,r[n*17+5]=i.y>>8&255,r[n*17+6]=i.y>>16&255,r[n*17+7]=i.offset&255,r[n*17+8]=he(i.offset,8)&255,r[n*17+9]=he(i.offset,16)&255,r[n*17+10]=he(i.offset,24)&255,r[n*17+11]=he(i.offset,32)&255,r[n*17+12]=he(i.offset,48)&255,r[n*17+13]=i.length&255,r[n*17+14]=i.length>>8&255,r[n*17+15]=i.length>>16&255,r[n*17+16]=i.length>>24&255}return e},mr=(t,e)=>{if(t.byteLength<17)return null;let r=t.byteLength/17,n=At(t,r-1);if(n.is_dir){let i=n.z,a=e.z-i,o=Math.trunc(e.x/(1<<a)),u=Math.trunc(e.y/(1<<a));return{z:i,x:o,y:u}}return null};async function yr(t){let e=await t.getBytes(0,512e3),r=new DataView(e.data),n=r.getUint32(4,!0),i=r.getUint16(8,!0),a=new TextDecoder("utf-8"),o=JSON.parse(a.decode(new DataView(e.data,10,n))),u=0;o.compression==="gzip"&&(u=2);let f=0;"minzoom"in o&&(f=+o.minzoom);let s=0;"maxzoom"in o&&(s=+o.maxzoom);let h=0,l=0,c=0,A=-180,w=-85,v=180,y=85;if(o.bounds){let m=o.bounds.split(",");A=+m[0],w=+m[1],v=+m[2],y=+m[3]}if(o.center){let m=o.center.split(",");h=+m[0],l=+m[1],c=+m[2]}return{specVersion:r.getUint16(2,!0),rootDirectoryOffset:10+n,rootDirectoryLength:i*17,jsonMetadataOffset:10,jsonMetadataLength:n,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:u,tileType:1,minZoom:f,maxZoom:s,minLon:A,minLat:w,maxLon:v,maxLat:y,centerZoom:c,centerLon:h,centerLat:l,etag:e.etag}}async function wr(t,e,r,n,i,a,o){let u=await r.getArrayBuffer(e,t.rootDirectoryOffset,t.rootDirectoryLength,t);t.specVersion===1&&(u=wt(u));let f=yt(new DataView(u),n,i,a);if(f){let l=(await e.getBytes(f.offset,f.length,o)).data,c=new DataView(l);return c.getUint8(0)==31&&c.getUint8(1)==139&&(l=Ze(new Uint8Array(l))),{data:l}}let s=mr(new DataView(u),{z:n,x:i,y:a});if(s){let h=vr(new DataView(u),s.z,s.x,s.y);if(h){let l=await r.getArrayBuffer(e,h.offset,h.length,t);t.specVersion===1&&(l=wt(l));let c=yt(new DataView(l),n,i,a);if(c){let w=(await e.getBytes(c.offset,c.length,o)).data,v=new DataView(w);return v.getUint8(0)==31&&v.getUint8(1)==139&&(w=Ze(new Uint8Array(w))),{data:w}}}}}var Re={getHeader:yr,getZxy:wr};function ie(t,e){return(e>>>0)*4294967296+(t>>>0)}function dr(t,e){let r=e.buf,n,i;if(i=r[e.pos++],n=(i&112)>>4,i<128||(i=r[e.pos++],n|=(i&127)<<3,i<128)||(i=r[e.pos++],n|=(i&127)<<10,i<128)||(i=r[e.pos++],n|=(i&127)<<17,i<128)||(i=r[e.pos++],n|=(i&127)<<24,i<128)||(i=r[e.pos++],n|=(i&1)<<31,i<128))return ie(t,n);throw new Error("Expected varint not more than 10 bytes")}function ve(t){let e=t.buf,r,n;return n=e[t.pos++],r=n&127,n<128||(n=e[t.pos++],r|=(n&127)<<7,n<128)||(n=e[t.pos++],r|=(n&127)<<14,n<128)||(n=e[t.pos++],r|=(n&127)<<21,n<128)?r:(n=e[t.pos],r|=(n&15)<<28,dr(r,t))}function zr(t,e,r,n){if(n==0){r==1&&(e[0]=t-1-e[0],e[1]=t-1-e[1]);let i=e[0];e[0]=e[1],e[1]=i}}var Ar=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function Ur(t,e,r){if(t>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(e>Math.pow(2,t)-1||r>Math.pow(2,t)-1)throw Error("tile x/y outside zoom level bounds");let n=Ar[t],i=Math.pow(2,t),a=0,o=0,u=0,f=[e,r],s=i/2;for(;s>0;)a=(f[0]&s)>0?1:0,o=(f[1]&s)>0?1:0,u+=s*s*(3*a^o),zr(s,f,a,o),s=s/2;return n+u}async function Ve(t,e){if(e===1||e===0)return t;if(e===2){let r=new Response(t).body,n=ut(TransformStream),i=r.pipeThrough(new n("gzip"));return new Response(i).arrayBuffer()}else throw Error("Compression method not supported")}var br=127;function Er(t,e){let r=0,n=t.length-1;for(;r<=n;){let i=n+r>>1,a=e-t[i].tileId;if(a>0)r=i+1;else if(a<0)n=i-1;else return t[i]}return n>=0&&(t[n].runLength===0||e-t[n].tileId<t[n].runLength)?t[n]:null}var He=class{url;constructor(e){this.url=e}getKey(){return this.url}async getBytes(e,r,n){let i;n||(i=new AbortController,n=i.signal);let a=await fetch(this.url,{signal:n,headers:{Range:"bytes="+e+"-"+(e+r-1)}});if(a.status===416&&e===0){let f=a.headers.get("Content-Range");if(!f||!f.startsWith("bytes */"))throw Error("Missing content-length on 416 response");let s=+f.substr(8);a=await fetch(this.url,{signal:n,headers:{Range:"bytes=0-"+(s-1)}})}if(a.status>=300)throw Error("Bad response code: "+a.status);let o=a.headers.get("Content-Length");if(a.status===200&&(!o||+o>r))throw i&&i.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:await a.arrayBuffer(),etag:a.headers.get("ETag")||void 0,cacheControl:a.headers.get("Cache-Control")||void 0,expires:a.headers.get("Expires")||void 0}}};function I(t,e){let r=t.getUint32(e+4,!0),n=t.getUint32(e+0,!0);return r*Math.pow(2,32)+n}function Dr(t,e){let r=new DataView(t),n=r.getUint8(7);if(n>3)throw Error(`Archive is spec version ${n} but this library supports up to spec version 3`);return{specVersion:n,rootDirectoryOffset:I(r,8),rootDirectoryLength:I(r,16),jsonMetadataOffset:I(r,24),jsonMetadataLength:I(r,32),leafDirectoryOffset:I(r,40),leafDirectoryLength:I(r,48),tileDataOffset:I(r,56),tileDataLength:I(r,64),numAddressedTiles:I(r,72),numTileEntries:I(r,80),numTileContents:I(r,88),clustered:r.getUint8(96)===1,internalCompression:r.getUint8(97),tileCompression:r.getUint8(98),tileType:r.getUint8(99),minZoom:r.getUint8(100),maxZoom:r.getUint8(101),minLon:r.getInt32(102,!0)/1e7,minLat:r.getInt32(106,!0)/1e7,maxLon:r.getInt32(110,!0)/1e7,maxLat:r.getInt32(114,!0)/1e7,centerZoom:r.getUint8(118),centerLon:r.getInt32(119,!0)/1e7,centerLat:r.getInt32(123,!0)/1e7,etag:e}}function Ut(t){let e={buf:new Uint8Array(t),pos:0},r=ve(e),n=[],i=0;for(let a=0;a<r;a++){let o=ve(e);n.push({tileId:i+o,offset:0,length:0,runLength:1}),i+=o}for(let a=0;a<r;a++)n[a].runLength=ve(e);for(let a=0;a<r;a++)n[a].length=ve(e);for(let a=0;a<r;a++){let o=ve(e);o===0&&a>0?n[a].offset=n[a-1].offset+n[a-1].length:n[a].offset=o-1}return n}function Tr(t){let e=new DataView(t);return e.getUint16(2,!0)===2?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):e.getUint16(2,!0)===1?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}var V=class extends Error{};async function bt(t,e,r,n){let i=await t.getBytes(0,16384);if(new DataView(i.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");if(Tr(i.data)<3)return[await Re.getHeader(t)];let o=i.data.slice(0,br),u=i.etag;n&&i.etag!=n&&(console.warn("ETag conflict detected; your HTTP server might not support content-based ETag headers. ETags disabled for "+t.getKey()),u=void 0);let f=Dr(o,u);if(r){let s=i.data.slice(f.rootDirectoryOffset,f.rootDirectoryOffset+f.rootDirectoryLength),h=t.getKey()+"|"+(f.etag||"")+"|"+f.rootDirectoryOffset+"|"+f.rootDirectoryLength,l=Ut(await e(s,f.internalCompression));return[f,[h,l.length,l]]}return[f,void 0]}async function Et(t,e,r,n,i){let a=await t.getBytes(r,n);if(i.etag&&i.etag!==a.etag)throw new V(a.etag);let o=await e(a.data,i.internalCompression),u=Ut(o);if(u.length===0)throw new Error("Empty directory is invalid");return u}var Ae=class{cache;maxCacheEntries;counter;prefetch;decompress;constructor(e=100,r=!0,n=Ve){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.prefetch=r,this.decompress=n}async getHeader(e,r){let n=e.getKey();if(this.cache.has(n))return this.cache.get(n).lastUsed=this.counter++,this.cache.get(n).data;let i=await bt(e,this.decompress,this.prefetch,r);return i[1]&&this.cache.set(i[1][0],{lastUsed:this.counter++,data:i[1][2]}),this.cache.set(n,{lastUsed:this.counter++,data:i[0]}),this.prune(),i[0]}async getDirectory(e,r,n,i){let a=e.getKey()+"|"+(i.etag||"")+"|"+r+"|"+n;if(this.cache.has(a))return this.cache.get(a).lastUsed=this.counter++,this.cache.get(a).data;let o=await Et(e,this.decompress,r,n,i);return this.cache.set(a,{lastUsed:this.counter++,data:o}),this.prune(),o}async getArrayBuffer(e,r,n,i){let a=e.getKey()+"|"+(i.etag||"")+"|"+r+"|"+n;if(this.cache.has(a))return this.cache.get(a).lastUsed=this.counter++,await this.cache.get(a).data;let o=await e.getBytes(r,n);if(i.etag&&i.etag!==o.etag)throw new V(i.etag);return this.cache.set(a,{lastUsed:this.counter++,data:o.data}),this.prune(),o.data}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,r;this.cache.forEach((n,i)=>{n.lastUsed<e&&(e=n.lastUsed,r=i)}),r&&this.cache.delete(r)}}async invalidate(e,r){this.cache.delete(e.getKey()),await this.getHeader(e,r)}},Fe=class{cache;maxCacheEntries;counter;prefetch;decompress;constructor(e=100,r=!0,n=Ve){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.prefetch=r,this.decompress=n}async getHeader(e,r){let n=e.getKey();if(this.cache.has(n))return this.cache.get(n).lastUsed=this.counter++,await this.cache.get(n).data;let i=new Promise((a,o)=>{bt(e,this.decompress,this.prefetch,r).then(u=>{u[1]&&this.cache.set(u[1][0],{lastUsed:this.counter++,data:Promise.resolve(u[1][2])}),a(u[0]),this.prune()}).catch(u=>{o(u)})});return this.cache.set(n,{lastUsed:this.counter++,data:i}),i}async getDirectory(e,r,n,i){let a=e.getKey()+"|"+(i.etag||"")+"|"+r+"|"+n;if(this.cache.has(a))return this.cache.get(a).lastUsed=this.counter++,await this.cache.get(a).data;let o=new Promise((u,f)=>{Et(e,this.decompress,r,n,i).then(s=>{u(s),this.prune()}).catch(s=>{f(s)})});return this.cache.set(a,{lastUsed:this.counter++,data:o}),o}async getArrayBuffer(e,r,n,i){let a=e.getKey()+"|"+(i.etag||"")+"|"+r+"|"+n;if(this.cache.has(a))return this.cache.get(a).lastUsed=this.counter++,await this.cache.get(a).data;let o=new Promise((u,f)=>{e.getBytes(r,n).then(s=>{if(i.etag&&i.etag!==s.etag)throw new V(s.etag);u(s.data),this.cache.has(a),this.prune()}).catch(s=>{f(s)})});return this.cache.set(a,{lastUsed:this.counter++,data:o}),o}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,r;this.cache.forEach((n,i)=>{n.lastUsed<e&&(e=n.lastUsed,r=i)}),r&&this.cache.delete(r)}}async invalidate(e,r){this.cache.delete(e.getKey()),await this.getHeader(e,r)}},ce=class{source;cache;decompress;constructor(e,r,n){typeof e=="string"?this.source=new He(e):this.source=e,n?this.decompress=n:this.decompress=Ve,r?this.cache=r:this.cache=new Fe}async getHeader(){return await this.cache.getHeader(this.source)}async getZxyAttempt(e,r,n,i){let a=Ur(e,r,n),o=await this.cache.getHeader(this.source);if(o.specVersion<3)return Re.getZxy(o,this.source,this.cache,e,r,n,i);if(e<o.minZoom||e>o.maxZoom)return;let u=o.rootDirectoryOffset,f=o.rootDirectoryLength;for(let s=0;s<=3;s++){let h=await this.cache.getDirectory(this.source,u,f,o),l=Er(h,a);if(l)if(l.runLength>0){let c=await this.source.getBytes(o.tileDataOffset+l.offset,l.length,i);if(o.etag&&o.etag!==c.etag)throw new V(c.etag);return{data:await this.decompress(c.data,o.tileCompression),cacheControl:c.cacheControl,expires:c.expires}}else u=o.leafDirectoryOffset+l.offset,f=l.length;else return}throw Error("Maximum directory depth exceeded")}async getZxy(e,r,n,i){try{return await this.getZxyAttempt(e,r,n,i)}catch(a){if(a instanceof V)return this.cache.invalidate(this.source,a.message),await this.getZxyAttempt(e,r,n,i);throw a}}async getMetadataAttempt(){let e=await this.cache.getHeader(this.source),r=await this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength);if(e.etag&&e.etag!==r.etag)throw new V(r.etag);let n=await this.decompress(r.data,e.internalCompression),i=new TextDecoder("utf-8");return JSON.parse(i.decode(n))}async getMetadata(){try{return await this.getMetadataAttempt()}catch(e){if(e instanceof V)return this.cache.invalidate(this.source,e.message),await this.getMetadataAttempt();throw e}}};var Dt=(t,e)=>e?e.replaceAll("{name}",t):t+".pmtiles",Mr=/^\/(?<NAME>[0-9a-zA-Z\/!\-_\.\*\'\(\)]+)\/(?<Z>\d+)\/(?<X>\d+)\/(?<Y>\d+).(?<EXT>[a-z]+)$/,Cr=/^\/(?<NAME>[0-9a-zA-Z\/!\-_\.\*\'\(\)]+).json$/,Tt=t=>{let e=t.match(Mr);if(e){let n=e.groups;return{ok:!0,name:n.NAME,tile:[+n.Z,+n.X,+n.Y],ext:n.EXT}}let r=t.match(Cr);return r?{ok:!0,name:r.groups.NAME,ext:"json"}:{ok:!1,name:"",tile:[0,0,0],ext:""}},Mt=(t,e,r,n)=>{let i="";return t.tileType===1?i=".mvt":t.tileType===2?i=".png":t.tileType===3?i=".jpg":t.tileType===4?i=".webp":t.tileType===5&&(i=".avif"),{tilejson:"3.0.0",scheme:"xyz",tiles:["https://"+r+"/"+n+"/{z}/{x}/{y}"+i],vector_layers:e.vector_layers,attribution:e.attribution,description:e.description,name:e.name,version:e.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}};var Ue=class extends Error{constructor(e){super(e)}};async function Ct(t,e){if(e===1||e===0)return t;if(e===2){let n=new Response(t).body.pipeThrough(new DecompressionStream("gzip"));return new Response(n).arrayBuffer()}else throw Error("Compression method not supported")}var Sr=new Ae(25,void 0,Ct),Ge=class{env;archive_name;constructor(e,r){this.env=e,this.archive_name=r}getKey(){return this.archive_name}async getBytes(e,r){let n=await this.env.BUCKET.get(Dt(this.archive_name,this.env.PMTILES_PATH),{range:{offset:e,length:r}});if(!n)throw new Ue("Archive not found");let i=n;return{data:await i.arrayBuffer(),etag:i.etag,cacheControl:i.httpMetadata?.cacheControl,expires:i.httpMetadata?.cacheExpiry?.toISOString()}}},fn={async fetch(t,e,r){if(t.method.toUpperCase()==="POST")return new Response(void 0,{status:405});let n=new URL(t.url),{ok:i,name:a,tile:o,ext:u}=Tt(n.pathname),f=caches.default;if(i){let s="";if(typeof e.ALLOWED_ORIGINS<"u")for(let v of e.ALLOWED_ORIGINS.split(","))(v===t.headers.get("Origin")||v==="*")&&(s=v);let h=await f.match(t.url);if(h){let v=new Headers(h.headers);return s&&v.set("Access-Control-Allow-Origin",s),v.set("Vary","Origin"),new Response(h.body,{headers:v,status:h.status})}let l=(v,y,z)=>{y.set("Cache-Control","max-age="+(e.CACHE_MAX_AGE||86400));let m=new Response(v,{headers:y,status:z});r.waitUntil(f.put(t.url,m));let B=new Headers(y);return s&&B.set("Access-Control-Allow-Origin",s),B.set("Vary","Origin"),new Response(v,{headers:B,status:z})},c=new Headers,A=new Ge(e,a),w=new ce(A,Sr,Ct);try{let v=await w.getHeader();if(!o){c.set("Content-Type","application/json");let z=Mt(v,await w.getMetadata(),e.PUBLIC_HOSTNAME||n.hostname,a);return l(JSON.stringify(z),c,200)}if(o[0]<v.minZoom||o[0]>v.maxZoom)return l(void 0,c,404);for(let z of[[1,"mvt"],[2,"png"],[3,"jpg"],[4,"webp"],[5,"avif"]])if(v.tileType===z[0]&&u!==z[1]){if(v.tileType==1&&u==="pbf")continue;return l(`Bad request: requested .${u} but archive has type .${z[1]}`,c,400)}let y=await w.getZxy(o[0],o[1],o[2]);switch(v.tileType){case 1:c.set("Content-Type","application/x-protobuf");break;case 2:c.set("Content-Type","image/png");break;case 3:c.set("Content-Type","image/jpeg");break;case 4:c.set("Content-Type","image/webp");break}return y?l(y.data,c,200):l(void 0,c,204)}catch(v){if(v instanceof Ue)return l("Archive not found",c,404);throw v}}return new Response("Invalid URL",{status:404})}};export{fn as default};
//# sourceMappingURL=index.js.map
